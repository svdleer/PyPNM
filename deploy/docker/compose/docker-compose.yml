services:
  pypnm-api:
    image: "ghcr.io/svdleer/pypnm:${PYPNM_TAG:-latest}"
    container_name: pypnm-api
    restart: unless-stopped
    env_file:
      - .env
    environment:
      PYPNM_LOG_LEVEL: "${PYPNM_LOG_LEVEL:-info}"
    ports:
      - "${PYPNM_PORT:-8000}:8000"
    volumes:
      - type: bind
        source: ../config/system.json
        target: /app/config/system.json
        read_only: true
      - pypnm_logs:/app/logs
      - pypnm_data:/app/.data
      - pypnm_output:/app/output
    healthcheck:
      test:
        ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/docs').read()\""]
      interval: 10s
      timeout: 3s
      retries: 15
    labels:
      - "com.pypnm.role=api"

  config-menu:
    image: "ghcr.io/svdleer/pypnm:${PYPNM_TAG:-latest}"
    container_name: pypnm-config-menu
    stdin_open: true
    tty: true
    restart: "no"
    env_file:
      - .env
    environment:
      PYPNM_LOG_LEVEL: "${PYPNM_LOG_LEVEL:-info}"
    entrypoint: ["/app/entrypoint.sh"]
    command: ["python", "tools/system_config/menu.py"]
    volumes:
      - type: bind
        source: ../config/system.json
        target: /app/config/system.json
      - pypnm_logs:/app/logs
      - pypnm_data:/app/.data
      - pypnm_output:/app/output

volumes:
  pypnm_logs:
  pypnm_data:
  pypnm_output:
